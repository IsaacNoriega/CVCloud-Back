name: CI/CD Backend CloudProject

on:
  push:
    branches: [ "deploy" , "main" ]

env:
  # Usamos el secreto para que sea dinámico si cambia el lab
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  IMAGE_BACKEND: cloudproject/backend

jobs:
  build-and-push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build & Push Backend

        run: |
          docker build -t ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_BACKEND }}:latest .
          docker push ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_BACKEND }}:latest

  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          # Corregido: Usar el secreto correcto para la llave
          key: ${{ secrets.EC2_SHH_KEY }} 
          port: 22
          # Pasamos todas las variables de la app a la sesión SSH
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_SESSION_TOKEN,AWS_ACCOUNT_ID,DATABASE_URL,JWT_SECRET,SALT,AWS_S3_BUCKET,API_GATEWAY_URL,AWS_REGION
          script: |
            # --- 1. CARGAR CREDENCIALES EN LA SESIÓN (Soluciona 'Unable to locate credentials') ---
            # Esto es lo que corrige el error manual en el servidor
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_SESSION_TOKEN=${{ secrets.AWS_SESSION_TOKEN }}
            export AWS_REGION=${{ secrets.AWS_REGION }}

            # --- 2. CONFIGURACIÓN DEL ENTORNO ---
            # Navegar a la carpeta del proyecto
            mkdir -p /home/ec2-user/Cloud-Project-WS
            cd /home/ec2-user/Cloud-Project-WS
            
            # Crear el .env dinámicamente con las variables de GitHub Secrets

            echo "Generando .env..."
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "SALT=${{ secrets.SALT }}" >> .env
            echo "API_GATEWAY_URL=${{ secrets.API_GATEWAY_URL }}" >> .env
            echo "AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}" >> .env
            echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
            echo "AWS_SESSION_TOKEN=${{ secrets.AWS_SESSION_TOKEN }}" >> .env
            
            # --- 3. LOGUEAR A ECR Y DESPLEGAR ---
            echo "Iniciando despliegue de Docker Compose..."
            
            # Login a ECR (Ahora SÍ funcionará porque las credenciales ya están exportadas)
            aws ecr get-login-password --region $AWS_REGION | \
            docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
            
            # Despliegue final
            docker-compose pull
            docker-compose up -d --remove-orphans
            docker image prune -f